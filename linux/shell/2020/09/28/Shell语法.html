<!DOCTYPE html>
<html>
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Shell语法</title>
    <script type="text/javascript" src="/assets/js/prism.js"></script>
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/prism.css">
    <script type="text/javascript" src="/assets/js/jquery-3.6.0.js"></script>
    <script src="/assets/js/scrollnav.min.umd.js"></script>
  <script>MathJax={"tex":{"inlineMath":[["$","$"],["\\(","\\)"]],"displayMath":[["$$","$$"],["\\[","\\]"]]},"svg":{"fontCache":"global"}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
  <body>
    <div class="wrapper">
      <div class="clearfloat">
        <nav class="navbar">
    <!-- <a href="/" >
        Home
    </a>
    <a href="/about.html" >
        About
    </a> -->
    
        <!-- <a href="https://github.com/Zhniing"  target="_self"> -->
        <a href="https://github.com/Zhniing" target="_blank">
            Github
        </a>
    
        <!-- <a href="/about.html"  target="_self"> -->
        <a href="/about.html" target="_self">
            About
        </a>
    
        <!-- <a href="/games/hiker"  target="_self"> -->
        <a href="/games/hiker" target="_self">
            Game
        </a>
    
        <!-- <a href="/"  target="_self"> -->
        <a href="/" target="_self">
            Home
        </a>
    
</nav>
      </div>
      <base target="_blank"> <!-- 仅post页面的a标签为_blank -->

<h1>Shell语法</h1>
<!-- <p>Posted on 28 Sep 2020, Last updated: </p> -->
<!-- <p>发表于 2020 年 09 月 28 日 | 更新于 </p> -->
<p>发布于 2020 年 09 月 28 日  | 更新于 2022 年 04 月 03 日 </p>

<div class="post_content">
    <h2 id="特殊变量">特殊变量</h2>

<p>获取所有参数：</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">$@</code>：将每个参数视为独立个体（可用于for循环）</li>
  <li>
<code class="language-plaintext highlighter-rouge">$*</code>：将所有参数视为一个整体</li>
  <li>参考：<a href="http://c.biancheng.net/view/807.html">Shell $*和$@的区别</a>
</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">$#</code>参数个数</p>

<p><code class="language-plaintext highlighter-rouge">$$</code>当前进程的id</p>

<ul>
  <li>
    <p>当前环境中执行<code class="language-plaintext highlighter-rouge">. &lt;.sh&gt;</code>或<code class="language-plaintext highlighter-rouge">source &lt;.sh&gt;</code>，<strong>可以继承</strong>当前环境的变量，<code class="language-plaintext highlighter-rouge">$$</code>不变</p>
  </li>
  <li>
    <p>使用<code class="language-plaintext highlighter-rouge">sh</code>，<code class="language-plaintext highlighter-rouge">bash</code>或直接运行脚本<code class="language-plaintext highlighter-rouge">./xx.sh</code>，都<strong>无法继承</strong>当前环境的变量，新的<code class="language-plaintext highlighter-rouge">$$</code></p>
  </li>
</ul>

<h2 id="数组">数组</h2>

<p><code class="language-plaintext highlighter-rouge">a=(1 2 3)</code>用空格分割</p>

<p>下标访问：<code class="language-plaintext highlighter-rouge">${a[$i]}</code></p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">bash</code>：下标从0开始</li>
  <li>
<code class="language-plaintext highlighter-rouge">zsh</code>：下标从1开始<img class="emoji" title=":exclamation:" alt=":exclamation:" raw="❗️" src="https://github.githubassets.com/images/icons/emoji/unicode/2757.png" style="vertical-align: middle; display: inline; max-width: 1em; visibility: hidden;" onload="this.style.visibility='visible'" onerror="this.replaceWith(this.getAttribute('raw'))">
</li>
</ul>

<h2 id="bash参数">Bash参数</h2>

<p>脚本第一行<code class="language-plaintext highlighter-rouge">#!&lt;shell path&gt; [options]</code>指定用哪个shell来执行该脚本，<strong>常用选项</strong>(options)如下：</p>

<p><code class="language-plaintext highlighter-rouge">-e</code>：表示任意指令返回非真值（非0值）时结束脚本，写作<code class="language-plaintext highlighter-rouge">#!/bin/bash -e</code></p>

<p>更多选项参考<code class="language-plaintext highlighter-rouge">bash -c "help set"</code>，<a href="https://man7.org/linux/man-pages/man1/set.1p.html">online man: set(1p)</a>更详细</p>

<h2 id="if">if</h2>

<p><code class="language-plaintext highlighter-rouge">if</code>本质上是在判断<strong>后续命令</strong>的<strong>返回值</strong>：0为真，非0为假</p>

<p><code class="language-plaintext highlighter-rouge">true</code>和<code class="language-plaintext highlighter-rouge">false</code>是两个命令，<code class="language-plaintext highlighter-rouge">true</code>返回0，<code class="language-plaintext highlighter-rouge">false</code>返回1</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if </span><span class="nb">ls</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo </span>1<span class="p">;</span> <span class="k">fi</span>  <span class="c"># 真</span>
<span class="k">if return </span>1<span class="p">;</span> <span class="k">then </span><span class="nb">echo </span>1<span class="p">;</span> <span class="k">fi</span>  <span class="c"># 假</span>
<span class="k">if </span>sl<span class="p">;</span> <span class="k">then </span><span class="nb">echo </span>1<span class="p">;</span> <span class="k">fi</span>  <span class="c"># 直接报错 command not found: sl</span>
<span class="k">if </span><span class="nb">true</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo </span>1<span class="p">;</span> <span class="k">fi</span>  <span class="c"># 真</span>
<span class="k">if </span><span class="nb">false</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo </span>1<span class="p">;</span> <span class="k">fi</span>  <span class="c"># 假</span>
</code></pre></div></div>

<h2 id="变量">变量</h2>

<p>shell变量本质上就是<strong>宏替换</strong>，可以将命令赋给一个变量，然后通过<code class="language-plaintext highlighter-rouge">$</code>+变量名来执行命令</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">var</span><span class="o">=</span><span class="nb">ls</span>  <span class="c"># z='ls' z="ls" 都是一样</span>
<span class="nv">$var</span>  <span class="c"># 执行 ls</span>
</code></pre></div></div>

<p>所以：可以将<code class="language-plaintext highlighter-rouge">true</code>或<code class="language-plaintext highlighter-rouge">false</code>赋给一个变量，然后放在<code class="language-plaintext highlighter-rouge">if</code>后面进行判断</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">var</span><span class="o">=</span><span class="nb">true
</span><span class="k">if</span> <span class="nv">$var</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo </span>1<span class="p">;</span> <span class="k">fi</span>  <span class="c"># 真</span>
<span class="nv">var</span><span class="o">=</span><span class="nb">false
</span><span class="k">if</span> <span class="nv">$var</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo </span>1<span class="p">;</span> <span class="k">fi</span>  <span class="c"># 假</span>
</code></pre></div></div>

<h3 id="双引号">双引号</h3>

<p><code class="language-plaintext highlighter-rouge">bash</code>中的所有变量最好都用双引号括起来</p>

<p>在打印一个变量时，如果含有<strong>空白字符</strong>（空格、制表、换行等），通常会用双引号括起来，否则会被<code class="language-plaintext highlighter-rouge">shell</code>按通配符进行解析</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="sb">`</span><span class="nb">ls</span> <span class="nt">-l</span><span class="sb">`</span>  <span class="c"># 无换行</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="sb">`</span><span class="nb">ls</span> <span class="nt">-l</span><span class="sb">`</span><span class="s2">"</span>  <span class="c"># 正常显示换行</span>
</code></pre></div></div>

<blockquote>
  <p>Outside of double quotes, <code class="language-plaintext highlighter-rouge">$var</code> takes the value of <code class="language-plaintext highlighter-rouge">var</code>, splits it into whitespace-delimited parts, and interprets each part as a glob (wildcard) pattern. Unless you want this behavior, always put <code class="language-plaintext highlighter-rouge">$var</code> inside double quotes: <code class="language-plaintext highlighter-rouge">"$var"</code>.</p>

  <p>不用双引号的话，变量会被拆分为多个部分（以<em>空白字符</em>为分割），每个部分被当作一个通配符(wildcard)进行解析</p>

  <p>– <a href="https://riptutorial.com/bash/example/2464/double-quotes-for-variable-and-command-substitution">Double quotes for variable and command substitution</a></p>
</blockquote>

<p>参考：</p>

<ul>
  <li><a href="https://blog.csdn.net/u011729865/article/details/71773379">bash编程中，变量“用双引号”和“不用双引号”的区别</a></li>
  <li><a href="https://www.zhihu.com/question/33466555/answer/56605463">shell编程中用双引号引用参数和不用双引号有什么区别？</a></li>
</ul>

<h2 id="条件表达式">条件表达式</h2>

<p>条件表达式主要有几种形式：<a href="https://unix.stackexchange.com/questions/306111/what-is-the-difference-between-the-bash-operators-vs-vs-vs">ref</a></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">test EXPRESSION</code></li>
  <li><code class="language-plaintext highlighter-rouge">[ EXPRESSION ]</code></li>
  <li><code class="language-plaintext highlighter-rouge">[[ EXPRESSION ]]</code></li>
  <li><code class="language-plaintext highlighter-rouge">(( EXPRESSION ))</code></li>
</ul>

<p><a href="https://tldp.org/LDP/abs/html/testconstructs.html#DBLPRX">Test Constructs</a></p>

<h3 id="-和-test">[ 和 test</h3>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">[</code> is another name for the traditional <code class="language-plaintext highlighter-rouge">test</code> command.</p>
</blockquote>

<p>关于<code class="language-plaintext highlighter-rouge">if [ EXPRESSION ]</code>，左右方括号必须要隔空格的原因是：Shell将<code class="language-plaintext highlighter-rouge">[</code>当作一条<strong>指令</strong><img class="emoji" title=":sweat_smile:" alt=":sweat_smile:" raw="😅" src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png" style="vertical-align: middle; display: inline; max-width: 1em; visibility: hidden;" onload="this.style.visibility='visible'" onerror="this.replaceWith(this.getAttribute('raw'))"></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>which <span class="o">[</span>
<span class="o">[</span>: shell built-in <span class="nb">command
</span>whereis <span class="o">[</span>
<span class="o">[</span>: /usr/bin/[ /usr/share/man/man1/[.1.gz
<span class="nb">ls</span> <span class="nt">-l</span> /usr/bin/<span class="se">\[</span>
<span class="nt">-rwxr-xr-x</span> 1 root root 59736 Sep  5  2019 <span class="s1">'/usr/bin/['</span>
<span class="c"># 可以看到'['是一个可执行文件</span>
</code></pre></div></div>

<p>因此，也可以直接在<strong>交互Shell</strong>中测试<code class="language-plaintext highlighter-rouge">[ EXPRESSION ]</code>的返回值(<code class="language-plaintext highlighter-rouge">$?</code>)</p>

<p>由于<code class="language-plaintext highlighter-rouge">&amp;&amp;</code>和<code class="language-plaintext highlighter-rouge">||</code>被Shell用于<em>连接两条命令</em>，因此，<code class="language-plaintext highlighter-rouge">[ EXPRESSION ]</code>中出现<code class="language-plaintext highlighter-rouge">&amp;&amp;</code>和<code class="language-plaintext highlighter-rouge">||</code>时，会被认为是第二条指令，然后报错找不到<code class="language-plaintext highlighter-rouge">]</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span> 1 <span class="o">&amp;&amp;</span> 2 <span class="o">]</span> <span class="c"># False(返回值非0)</span>
<span class="o">[</span>: <span class="s1">']'</span> expected <span class="c"># 报错</span>
<span class="o">[</span> 1 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> 2 <span class="o">]</span> <span class="c"># True(返回值为0)</span>
</code></pre></div></div>

<h3>[[</h3>

<p><code class="language-plaintext highlighter-rouge">[[</code>是<code class="language-plaintext highlighter-rouge">test</code>命令的一种改版，可以使用<code class="language-plaintext highlighter-rouge">&amp;&amp;</code>和<code class="language-plaintext highlighter-rouge">||</code></p>

<p>正则匹配：使用<code class="language-plaintext highlighter-rouge">=~</code>来正则地比较字符串（好像只用<code class="language-plaintext highlighter-rouge">=</code>也支持正则），<em>字符串在左，正则模式在右</em></p>

<h3 id="-1">((</h3>

<p>主要用于<strong>算数运算</strong>，支持C-style的自增自减(++/–)</p>

<p><a href="https://tldp.org/LDP/abs/html/dblparens.html">The Double-Parentheses Construct</a></p>

<p><a href="https://www.man7.org/linux/man-pages/man1/bash.1.html#ARITHMETIC_EVALUATION">ARITHMETIC EVALUATION</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">a</span><span class="o">=</span><span class="k">$((</span> <span class="m">3</span> <span class="o">+</span> <span class="m">5</span> <span class="k">))</span>  <span class="c"># shell里面这种‘a’和‘=’分开的话，一般情况下a会被当成指令</span>
<span class="o">((</span> a++ <span class="o">))</span>
<span class="nb">echo</span> <span class="nv">$a</span>  <span class="c"># 9</span>
</code></pre></div></div>

<h3 id="test-操作符">test 操作符</h3>

<p>更多参见<code class="language-plaintext highlighter-rouge">man bash</code>的<strong><a href="https://www.man7.org/linux/man-pages/man1/bash.1.html#CONDITIONAL_EXPRESSIONS">CONDITIONAL EXPRESSIONS</a></strong>章节</p>

<ul>
  <li>
    <p>字符串</p>

    <p><code class="language-plaintext highlighter-rouge">-z</code>字符串长度为0返回true</p>

    <p><code class="language-plaintext highlighter-rouge">-n</code>字符串长度<strong>不</strong>为0返回true</p>
  </li>
  <li>
    <p>文件</p>

    <p><code class="language-plaintext highlighter-rouge">-e</code>文件存在</p>

    <p><code class="language-plaintext highlighter-rouge">-d</code>文件存在&amp;是目录</p>

    <p><code class="language-plaintext highlighter-rouge">-f</code>文件存在&amp;是普通文件（非目录或设备文件）</p>
  </li>
  <li>
    <p><strong>数值</strong>比较</p>

    <p><img class="emoji" title=":bangbang:" alt=":bangbang:" raw="‼️" src="https://github.githubassets.com/images/icons/emoji/unicode/203c.png" style="vertical-align: middle; display: inline; max-width: 1em; visibility: hidden;" onload="this.style.visibility='visible'" onerror="this.replaceWith(this.getAttribute('raw'))">在<code class="language-plaintext highlighter-rouge">[[</code>中<em>必须</em>使用<code class="language-plaintext highlighter-rouge">-gt</code>这类操作符，使用<code class="language-plaintext highlighter-rouge">&lt;</code>这类符号会被当作<strong>字符串比较</strong></p>

    <p>在<code class="language-plaintext highlighter-rouge">((</code>中，可以用<code class="language-plaintext highlighter-rouge">&lt;</code>符号</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="o">[[</span> 2 &lt; 10 <span class="o">]]</span>  <span class="c"># False (exit status 1)</span>
<span class="o">((</span> 2 &lt; 10 <span class="o">))</span>  <span class="c"># True (exit status 0)</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="参数扩展">参数扩展</h2>

<p><code class="language-plaintext highlighter-rouge">${parameter:-word}</code>：使用<strong>默认值</strong>，如果<code class="language-plaintext highlighter-rouge">parameter</code>不存在，就以<code class="language-plaintext highlighter-rouge">word</code>作为其值</p>

<p>更多参考<code class="language-plaintext highlighter-rouge">man bash</code>的<a href="https://www.man7.org/linux/man-pages/man1/bash.1.html#:~:text=in%20posix%20mode.-,Parameter%20Expansion,-The%20%60%24%27%20character%20introduces">Parameter Expansion</a>小节</p>

<h2 id="杂项">杂项</h2>

<p><code class="language-plaintext highlighter-rouge">$?</code>：这个变量保存了上一条<strong>指令</strong>的<strong>返回值</strong></p>

<p><strong>赋值</strong><code class="language-plaintext highlighter-rouge">=</code>两边不能有<em>空格</em>，<strong>判断</strong><code class="language-plaintext highlighter-rouge">=</code>两边必须要有<em>空格</em></p>

<p>判断是否传入参数（参数是否存在）：直接<code class="language-plaintext highlighter-rouge">$1</code></p>

<p>函数获取返回值<code class="language-plaintext highlighter-rouge">$(function name)</code></p>

<p>全局变量？？？</p>

<h2 id="管道命令执行顺序">管道命令执行顺序</h2>

<p>用管道连接的命令是<strong>同时</strong>执行的</p>

<p>比如<code class="language-plaintext highlighter-rouge">ps a | grep bash</code>的执行结果中，会出现<code class="language-plaintext highlighter-rouge">grep</code>的进程</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ ps a | <span class="nb">grep </span>bash
  263 pts/0    Ss     0:00 <span class="nt">-bash</span>
  811 pts/0    S+     0:00 <span class="nb">grep </span>bash
</code></pre></div></div>

<p>说明在<code class="language-plaintext highlighter-rouge">ps</code>在执行打印进程信息的时候，<code class="language-plaintext highlighter-rouge">grep</code>也在执行了，也就是说<code class="language-plaintext highlighter-rouge">ps</code>和<code class="language-plaintext highlighter-rouge">grep</code>是同时执行的</p>

<p>只不过<code class="language-plaintext highlighter-rouge">grep</code>执行到需要输入的时候就会停下来(状态S+)，等待I/O（<code class="language-plaintext highlighter-rouge">ps</code>的标准输出）</p>

<h2 id="zsh和bash的兼容性问题">Zsh和Bash的兼容性问题</h2>

<p>Zsh并不是完全兼容Bash</p>

<p>如果要<strong>完全兼容</strong>，使用<code class="language-plaintext highlighter-rouge">emulate bash</code> 或文件开头添加<code class="language-plaintext highlighter-rouge">#!/usr/bin/bash</code>（直接指定用bash执行该脚本）</p>

<p>目前遇到的不兼容情况：</p>

<ol>
  <li>条件表达式中，判断相等，Bash支持双等号<code class="language-plaintext highlighter-rouge">==</code>，而Zsh只支持单等号<code class="language-plaintext highlighter-rouge">=</code>
</li>
  <li>curl命令无法正常运行</li>
</ol>

<p>Shell中的<strong>字符串变量</strong>更像是C语言中的宏定义，运行时直接替换到目标位置，如果包含空格就容易引起歧义，因此通常将变量写在双引号内<code class="language-plaintext highlighter-rouge">"$a"</code>。</p>

<p>算数运算在((…))中进行，如<code class="language-plaintext highlighter-rouge">((i=i+1))</code></p>

<h2 id="算术运算">算术运算</h2>

<blockquote>
  <p>Bash arithmetic is limited to integers.</p>

  <p>– <a href="https://stackoverflow.com/questions/59187404/problem-with-bash-script-array-arithmetic-for-simple-sine-wave-generator">Problem with Bash Script array arithmetic for simple sine wave generator</a></p>
</blockquote>

</div>
    </div>
    <script>
      const ct = document.querySelector('.post_content');  //".post-content"指向文章内容所在的div，需根据实际情况修改
      scrollnav.init(ct, {
          debug: false,
          easingStyle: 'linear',
          //section为一级目录，subsection为二级目录
          sections: ($('.post_content > h1').length>0) ? 'h1' : 'h2',
          subSections: ($('.post_content > h1').length>0) ? 'h2' : 'h3',
      });
    </script>
    <script type="text/javascript">
      $('pre').addClass("line-numbers").css("white-space", "pre-wrap");
    </script>
  </body>
</html>
