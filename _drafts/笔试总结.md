---
last-updated-date: 2021-09-18 08:58:29+08:00
---

# 网络协议

## 协议栈 Protocol Stack

![Protocol Stack](https://img-blog.csdn.net/20161116144744393)

**TCP**和**UDP**都为**传输层**协议

## TCP

### 三次握手

用于建立TCP连接

![TCP](https://res-static.hc-cdn.cn/fms/img/0c6f5dc04e337b1c6deb57e82a9210d71603427626959)

报文格式

![TCP Message Format](https://img-blog.csdn.net/20140609125220296?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYTE5ODgxMDI5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

标志位：

- SYN：0/1
- ACK：0/1，传输数据过程中，ACK始终为1

序号：

- seq（**序号**）：占4个字节，每一个字节按照顺序编号，循环使用
- ack（**确认**序**号**）

### 第三次握手

意义在于：如果第一次握手的报文，长时间滞留在某些网络节点上，导致过了很久才到达服务器，那么这个报文实际上是一个过期报文，不应该建立连接。但是服务器不知道，还是会做第二次握手，这时客户端知道自己没有发起请求，所以不会做第三次握手，TCP连接也不会被建立。从而避免了建立过期报文的连接。

### 缺陷

服务端收到SYN报文（第一次握手）时，就会立即创建一个*传输控制模块*（TCB），占用相应系统资源，这一特性也被用来对服务器进行攻击：

**SYN Flood**，即拒绝服务攻击，通过向服务器发送大量伪造源地址的请求报文（第一次握手），服务器就会对这些源地址进行第二次握，由于收不到第三次握手，就会反复进行多次（tcp_syn_retries=5次），堆积大量**半开连接**，从而消耗大量内存和带宽，导致无法处理正常的请求。

**SYN Caches**，通过延迟分配TCB，来应对**SYN Flood**。进行第二次握手后，将这个**半开连接**存入一个专用Hash表，等到完成第三次握手后，再分配TCB，从而避免了系统资源被持续消耗。

### 长肥网络 Long Fat Network(LFN)

LFN，指长距离广域网、高带宽的网络环境

TCP协议设置了许多保证数据*可靠传输*的**效验**，这在低俗实验室环境下没有问题，但在远距离传输上，就会造成明显的**延迟**（**几百毫秒**）

## 参考

[TCP三次握手和四次挥手以及缺陷](https://www.jianshu.com/p/062a727862e9)

[补牢TCP/IP——适应长肥网络环境（上）](https://searchnetworking.techtarget.com.cn/12-15723/)

# 进程和线程

- 进程(**process**)：资源分配的最小单位；用来**隔离**系统资源（）
- 线程(**thread**)：CPU调度（执行任务）的基本单位；用来提高**并发**能力（切换开销小）

|   | 进程  | 线程 |
| :--- | :--: | :--: |
| 本质 | **资源**分配的最小单位 | CPU**调度**(执行任务)的基本单位 |
| 目标 | **隔离**系统资源(一个进程崩溃不影响其他进程) | 提高**并发**能力(切换开销小) |
| 独有 | **数据空间** | **运行栈**，程序计数器(**PC**) |
| 同步 | 简单 | 复杂(锁) |
| 共享 | 复杂(需借助**进程间通信IPC**) | 简单（共享所属进程的资源） |
| 数量 | 一个进程可以有多个线程 | 一个线程只能存在于一个进程 |

线程有**5种状态**：初始态，执行态，等待态，就绪态，终止态

## 同步和通信

**并发访问**同一个资源时，就需要同步，否则很容易出现**脏数据**

- 同步：使进程/线程按一定**先后顺序执行**（避免出现脏数据）
- 通信：进程/线程间**传输信息**



### 临界

- 临界资源：大家都可以访问的**共享资源**（如：全局变量，堆区变量）
- 临界区：访问临界资源的**代码片段**

### 进程间通信

> 进程同步是**目的**，进程通信是**手段**

Inter-Process Communication(**IPC**)，分为6种：管道，共享内存，信号，信号量，消息队列，套接字

1. 管道：`|`命令，本质是内核中的一段**缓存**，双方通过读写这段缓存实现**单向**通信（**半双工**），双向通信需要2个管道
2. 共享内存：由一个进程创建，供其他进程访问；**最快**的一种IPC方式（没有内存拷贝操作）；但依赖*锁*和*信号量*来进行同步
3. 信号：`kill -9`就是向进程发送一个**终止信号**，用于通知进程发生了某个事件（任何时候）
4. 信号量：本质是一个**计数器**，表示资源能被多少进程同时访问
5. 消息队列：可以传递有意义的**数据结构**（管道只能传字节流）
6. 套接字：不同主机间的进程通信（网络编程）

### 线程间同步

1. 互斥锁(**Mutex**)：
2. 读写锁
3. 自旋锁
4. 条件变量
5. 信号量

## 参考

[面试必问——线程与进程的区别](https://www.huaweicloud.com/articles/d90c9bf248c8f1731946d65786c95379.html)

[线程同步与进程同步方式](https://www.acwing.com/blog/content/7275/)/articles/d90c9bf248c8f1731946d65786c95379.html)

[线程同步与进程同步方式](https://www.acwing.com/blog/content/7275/)
/articles/d90c9bf248c8f1731946d65786c95379.html)

[线程同步与进程同步方式](https://www.acwing.com/blog/content/7275/)
/articles/d90c9bf248c8f1731946d65786c95379.html)

[线程同步与进程同步方式](https://www.acwing.com/blog/content/7275/)
/articles/d90c9bf248c8f1731946d65786c95379.html)

[线程同步与进程同步方式](https://www.acwing.com/blog/content/7275/)
