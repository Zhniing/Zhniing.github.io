<!DOCTYPE html>
<html>
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>医学图像相关</title>
    <script type="text/javascript" src="/assets/js/prism.js"></script>
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/prism.css">
    <script type="text/javascript" src="/assets/js/jquery-3.6.0.js"></script>
    <script src="/assets/js/scrollnav.min.umd.js"></script>
  </head>
  <body>
    <div class="wrapper">
      <div class="clearfloat">
        <nav class="navbar">
    <!-- <a href="/" >
        Home
    </a>
    <a href="/about.html" >
        About
    </a> -->
    
        <!-- <a href="https://github.com/Zhniing"  target="_self"> -->
        <a href="https://github.com/Zhniing" target="_blank">
            Github
        </a>
    
        <!-- <a href="/about.html"  target="_self"> -->
        <a href="/about.html" target="_self">
            About
        </a>
    
        <!-- <a href="/games/hiker"  target="_self"> -->
        <a href="/games/hiker" target="_self">
            Game
        </a>
    
        <!-- <a href="/"  target="_self"> -->
        <a href="/" target="_self">
            Home
        </a>
    
</nav>
      </div>
      <base target="_blank"> <!-- 仅post页面的a标签为_blank -->

<h1>医学图像相关</h1>
<!-- <p>Posted on 19 Mar 2021, Last updated: </p> -->
<!-- <p>发表于 2021 年 03 月 19 日 | 更新于 </p> -->
<p>发布于 2021 年 03 月 19 日  | 更新于 2022 年 01 月 13 日 </p>

<div class="post_content">
    <ul>
  <li>
    <p>TR</p>

    <p>Time of Repetition 重复时间</p>
  </li>
  <li>
    <p>3T MRI / 1.5T MRI</p>

    <p>T代表特斯拉Tesla，指MRI中使用的磁体强度，影响成像质量</p>
  </li>
  <li>
    <p>多序列 Multisequence</p>

    <p>Such as：T1-weighted, T1- weighted inversion recovery, and T2-weighted fluid attenuated inversion recovery</p>
  </li>
  <li>
    <p>多模态 multi-modal MR images（跟多序列应该是一个意思）</p>

    <p>Such as：T1-weighted, T2-weighted</p>
  </li>
  <li>
    <p>金标准 <strong>gold standard</strong></p>

    <p><strong>金标准</strong>是指当前临床医学界公认的诊断疾病的最可靠方法。（使用<strong>金标准</strong>的目的就是准确区分受试对象是否为某病患者）</p>

    <p>机器学习领域更倾向于使用Ground truth，也可以认为__金标准__能够很好地代表Ground truth</p>
  </li>
  <li>
    <p>部分容积效应 <a href="https://zhuanlan.zhihu.com/p/46252046">Partial Volume Effect</a></p>

    <p>一张512×512像素的磁共振图像，是把人体那一层的组织切成512×512个小立方体，采集每个小方体里的身体组织T1，T2信号的均值。这个小立方体称为体素。
像素正方体如果刚好处在信号差异大的地方，部分容积效应就明显。</p>

    <p>如果刚好一块取到灰质和白质的交界处，那么这块的灰度值就是这部分组织的均值（即灰质和白质的均值），不灰不白，也就会导致边界模糊</p>

    <p>一个体素所采样的体积（1x1x1mm，1x1x3mm等）越小，图像质量越高，轮廓细节也就越清晰</p>

    <p>参考：<a href="https://www.zhihu.com/question/45524247?sort=created">https://www.zhihu.com/question/45524247?sort=created</a></p>
  </li>
</ul>

<h2 id="图像格式">图像格式</h2>

<p>目前遇到过的格式：</p>

<ul>
  <li>
    <p><strong>Analyze 7.5</strong>：使用一对文件来保存图像的完整信息</p>

    <p><code class="language-plaintext highlighter-rouge">.img</code>以二进制保存图像数据，<code class="language-plaintext highlighter-rouge">.hdr</code>保存图像的meta-information（如：朝向orientation 等）</p>
  </li>
  <li>
    <p><strong>MINC (Medical Imaging NetCDF)</strong>：单个<code class="language-plaintext highlighter-rouge">.mnc</code>文件保存完整的图像信息</p>

    <p><a href="https://bic-mni.github.io/">MINC Toolkit</a>提供了格式转换等工具，Ubuntu可以直接通过<code class="language-plaintext highlighter-rouge">apt install minc-tools</code>安装，好像没有Windows版本</p>
  </li>
  <li>
    <p><strong>NIfTI-1/2 (Neuroimaging Informatics Technology Initiative)</strong>：Analyze格式的改良版；保留Analyze的<code class="language-plaintext highlighter-rouge">.hdr/.img</code>双文件保存形式，另外支持单个<code class="language-plaintext highlighter-rouge">.nii</code>文件保存完整的图像信息</p>
  </li>
</ul>

<blockquote>
  <p><a href="https://brainder.org/2012/09/23/the-nifti-file-format/">The NIFTI file format</a></p>
</blockquote>

<h3 id="用python读入医学图像">用python读入医学图像</h3>

<blockquote>
  <p><a href="https://blog.csdn.net/Emily_Buffy/article/details/104879558">python ,matlab 读取NIFTI(.nii)格式图像、FSL安装</a></p>
</blockquote>

<p>符号：</p>

<ul>
  <li>
<strong>S</strong>：矢状面 (Sagittal) 的切片数，冠状轴</li>
  <li>
<strong>C</strong>：冠状面 (Coronal) 的切片数，失状轴</li>
  <li>
<strong>A</strong>：横断面 (Axial) 的切片数，垂直轴</li>
</ul>

<p><a href="https://blog.csdn.net/zhangjipinggom/article/details/118523633">nii文件中的方向理解</a></p>

<p><a href="http://www.grahamwideman.com/gw/brain/orientation/orientterms.htm">Orientation and Voxel-Order Terminology: RAS, LAS, LPI, RPI, XYZ and All That</a></p>

<h4 id="simpleitk">SimpleITK</h4>

<blockquote>
  <p><a href="https://www.cnblogs.com/dyc99/p/12539365.html">reference</a></p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="n">SimpleITK</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img</span> <span class="o">=</span> <span class="n">SimpleITK</span><span class="p">.</span><span class="nc">ReadImage</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img_np</span> <span class="o">=</span> <span class="n">SimpleITK</span><span class="p">.</span><span class="nc">GetArrayFromImage</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img</span><span class="p">.</span><span class="nc">GetSize</span><span class="p">()</span>
<span class="p">(</span><span class="mi">144</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img_np</span><span class="p">.</span><span class="n">shape</span>
<span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">144</span><span class="p">)</span>
</code></pre></div></div>

<p>关于<strong>Analyze</strong>格式：新版本的SimpleITK(2.0.1)会显示弃用警告：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">WARNING</span><span class="p">:</span> <span class="n">In</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">bld</span><span class="o">/</span><span class="n">conda</span><span class="o">-</span><span class="n">bld</span><span class="o">/</span><span class="n">simpleitk_1602768442566</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">ITK</span><span class="o">/</span><span class="n">Modules</span><span class="o">/</span><span class="n">IO</span><span class="o">/</span><span class="n">NIFTI</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">itkNiftiImageIO</span><span class="p">.</span><span class="n">cxx</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1009</span>
<span class="nc">NiftiImageIO </span><span class="p">(</span><span class="mh">0x564c43e95320</span><span class="p">):</span> <span class="p">...</span><span class="o">/</span><span class="n">dataset</span><span class="o">/</span><span class="n">iseg2017</span><span class="o">/</span><span class="n">subject</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">label</span><span class="p">.</span><span class="n">img</span> <span class="ow">is</span> <span class="n">Analyze</span> <span class="nb">file</span> <span class="ow">and</span> <span class="n">it</span><span class="s">'s deprecated
</span></code></pre></div></div>

<p><a href="https://github.com/SimpleITK/SimpleITK/issues/1280">解决方案</a>，在读入图像前，执行：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SimpleITK</span><span class="p">.</span><span class="nc">ProcessObject_SetGlobalWarningDisplay</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p>关于<strong>MINC</strong>格式，SimpleITK好像无法读取</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">RuntimeError</span><span class="p">:</span>
<span class="nb">Exception</span> <span class="n">thrown</span> <span class="ow">in</span> <span class="n">SimpleITK</span> <span class="n">ImageFileReader_Execute</span><span class="p">:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">SimpleITK</span><span class="o">/</span><span class="n">Code</span><span class="o">/</span><span class="n">IO</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">sitkImageReaderBase</span><span class="p">.</span><span class="n">cxx</span><span class="p">:</span><span class="mi">105</span><span class="p">:</span>
<span class="n">sitk</span><span class="p">::</span><span class="n">ERROR</span><span class="p">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">determine</span> <span class="n">ImageIO</span> <span class="n">reader</span> <span class="k">for</span> <span class="s">"BrainWeb/slice_thickness/t1_icbm_normal_9mm_pn0_rf0.mnc.gz"</span>
</code></pre></div></div>

<h4 id="scikit-image">scikit-image</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="n">skimage.io</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img_np</span> <span class="o">=</span> <span class="n">skimage</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">plugin</span><span class="o">=</span><span class="s">'simpleitk'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img_np</span><span class="p">.</span><span class="n">shape</span>  <span class="c1"># 图像ndarray的形状为 (T, C, S)
</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">144</span><span class="p">)</span>
</code></pre></div></div>

<p>这种方法底层还是调用的SimpleITK包（需要另外安装SimpleITK），也会出现上述弃用警告</p>

<h4 id="nibabel">NiBabel</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="n">nibabel</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="n">numpy</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img</span> <span class="o">=</span> <span class="n">nibabel</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img_np</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="nf">get_fdata</span><span class="p">()</span>  <span class="c1"># 可以指定dtype，默认float64
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
<span class="p">(</span><span class="mi">144</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">img_np</span><span class="p">.</span><span class="n">shape</span>
<span class="p">(</span><span class="mi">144</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
</code></pre></div></div>

<p>以上三种方法读入的图像数据（ndarray）是完全一致的（每个像素都相同）：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">skimage.io</span> <span class="k">as</span> <span class="n">io</span>
<span class="kn">import</span> <span class="n">SimpleITK</span> <span class="k">as</span> <span class="n">sitk</span>
<span class="kn">import</span> <span class="n">nibabel</span> <span class="k">as</span> <span class="n">nib</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s">'xxx'</span>
<span class="n">plugin</span> <span class="o">=</span> <span class="s">'simpleitk'</span>

<span class="n">img1</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">plugin</span><span class="o">=</span><span class="n">plugin</span><span class="p">)</span>
<span class="n">img2</span> <span class="o">=</span> <span class="n">sitk</span><span class="p">.</span><span class="nc">ReadImage</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">img3</span> <span class="o">=</span> <span class="n">nib</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="n">img2</span> <span class="o">=</span> <span class="n">sitk</span><span class="p">.</span><span class="nc">GetArrayFromImage</span><span class="p">(</span><span class="n">img2</span><span class="p">)</span>
<span class="n">img3</span> <span class="o">=</span> <span class="n">img3</span><span class="p">.</span><span class="nf">get_fdata</span><span class="p">().</span><span class="nf">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="nf">print</span><span class="p">((</span><span class="n">img1</span> <span class="o">==</span> <span class="n">img2</span><span class="p">).</span><span class="nf">all</span><span class="p">())</span>  <span class="c1"># True
</span><span class="nf">print</span><span class="p">((</span><span class="n">img2</span> <span class="o">==</span> <span class="n">img3</span><span class="p">).</span><span class="nf">all</span><span class="p">())</span>  <span class="c1"># True
</span><span class="nf">print</span><span class="p">((</span><span class="n">img1</span> <span class="o">==</span> <span class="n">img3</span><span class="p">).</span><span class="nf">all</span><span class="p">())</span>  <span class="c1"># True
</span></code></pre></div></div>

<h2 id="convert3d">Convert3D</h2>

<p>安装ITK-SNAP会附带这个工具，位于ITK-SNAP安装目录的bin文件夹下 (Windows)</p>

<blockquote>
  <p>Convert3D (unix name <strong>c3d</strong>) is a command-line image processing tool that offers complementary features to ITK-SNAP.</p>

  <p>– <a href="http://www.itksnap.org/pmwiki/pmwiki.php?n=Convert3D.Convert3D">Convert3D Documentation</a></p>
</blockquote>

<p>设置数据类型(dtype)：<a href="https://sourceforge.net/p/c3d/git/ci/master/tree/doc/c3d.md#-type-specify-pixel-type-for-image-output">-type: Specify pixel type for image output</a></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># -type &lt; char | uchar | short | ushort | int | uint | float | double &gt;</span>
c3d input.img <span class="nt">-type</span> uchar out.img
</code></pre></div></div>

<p>设置体素大小(spacing)：<a href="https://sourceforge.net/p/c3d/git/ci/master/tree/doc/c3d.md#-spacing-set-voxel-spacing">-spacing: Set voxel spacing</a></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c3d input.nii <span class="nt">-spacing</span> 1x1x1mm <span class="nt">-o</span> out.img
</code></pre></div></div>

<p>设置图像方向(spacing)：<a href="https://sourceforge.net/p/c3d/git/ci/master/tree/doc/c3d.md#-orient-change-image-orientation">-orient: Change image orientation</a></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c3d input.img <span class="nt">-orient</span> LPI <span class="nt">-o</span> out.img
</code></pre></div></div>

<p>设置图像原点(spacing)：<a href="https://sourceforge.net/p/c3d/git/ci/master/tree/doc/c3d.md#-origin-set-image-origin">-origin: Set image origin</a></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c3d input.img <span class="nt">-origin</span> 100x100x100mm <span class="nt">-o</span> out.img
</code></pre></div></div>

</div>
    </div>
    <script>
      const ct = document.querySelector('.post_content');  //".post-content"指向文章内容所在的div，需根据实际情况修改
      scrollnav.init(ct, {
          debug: false,
          easingStyle: 'linear',
          //section为一级目录，subsection为二级目录
          sections: ($('.post_content > h1').length>0) ? 'h1' : 'h2',
          subSections: ($('.post_content > h1').length>0) ? 'h2' : 'h3',
      });
    </script>
    <script type="text/javascript">
      $('pre').addClass("line-numbers").css("white-space", "pre-wrap");
    </script>
  </body>
</html>
